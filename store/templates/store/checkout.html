{% extends 'store/main.html' %}
{% load static %}
{% block title %}
    <title>Checkout | Boutique</title>
{% endblock title %}
   
{% block body %}
<body>


  <style>
    .hidden{
      display: none!important;
    }

  </style>

    <div class="page-holder">
    
      <div class="container">
        <!-- HERO SECTION-->
        <section class="py-5 bg-light">
          <div class="container">
            <div class="row px-4 px-lg-5 py-lg-4 align-items-center">
              <div class="col-lg-6">
                <h1 class="h2 text-uppercase mb-0">Checkout</h1>
              </div>
              <div class="col-lg-6 text-lg-end">
                <nav aria-label="breadcrumb">
                  <ol class="breadcrumb justify-content-lg-end mb-0 px-0 bg-light">
                    <li class="breadcrumb-item"><a class="text-dark" href="{% url 'home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a class="text-dark" href="{% url 'cart' %}">Cart</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                  </ol>
                </nav>
              </div>
            </div>
          </div>
        </section>
        <section class="py-5" i>
          <!-- BILLING ADDRESS-->
          
          <div class="row">
            <div class="col-lg-8">
              <div class="box-element" id="form-wrapper">
              <form id="form">
                <div class="row gy-3">

                      <div id="user-info" class="row gy-3">
                                  <div class="col-lg-6">
                                    <label class="form-label text-sm text-uppercase" for="name">Name </label>
                                    <input class="form-control form-control-lg" type="text" id="name" placeholder="Name" required>
                                  </div>
                                  <div class="col-lg-6">
                                    <label class="form-label text-sm text-uppercase" for="email">Email address </label>
                                    <input class="form-control form-control-lg" type="email" id="email" required placeholder="e.g. Jason@example.com">
                                  </div>
                      </div> 


                      <div id="shipping-info" class="row gy-3">
                        <h2 class="h5 text-uppercase mb-4">Shipping details</h2>
                        
                              
                              <div class="col-lg-12">
                                <label class="form-label text-sm text-uppercase" for="address">Address line 1 </label>
                                <input class="form-control form-control-lg" type="text" id="address" required placeholder="House number and street name">
                              </div>
                      
                              <div class="col-lg-6">
                                <label class="form-label text-sm text-uppercase" for="city">City </label>
                                <input class="form-control form-control-lg" type="text" id="city" required>
                              </div>
                              <div class="col-lg-6">
                                <label class="form-label text-sm text-uppercase" for="state">State </label>
                                <input class="form-control form-control-lg" type="text" id="state" required>
                              </div>
                              <div class="col-lg-6">
                                <label class="form-label text-sm text-uppercase" for="city">Zip Code </label>
                                <input class="form-control form-control-lg" type="text" id="zipcode" required>
                              </div>
                              
                      </div>
                    
                                <div class="col-lg-12">
                                  <input id="form-button" class="btn btn-success btn-block" type="submit" value="Continue">
                                </div>
                </div>
              </form>
            </div>
            <br>
                        <div class="box-element hidden" id="payment-info">
                          <small>Paypal Options</small>
                            <button class="btn btn-success btn-block"  id="make-payment">Make payment</button>
                          </div>
                          
                        </div>
          </div>
            <!-- ORDER SUMMARY-->
            <div class="col-lg-4">
              <div class="card border-0 rounded-0 p-lg-4 bg-light">
                <div class="card-body">
                  <h5 class="text-uppercase mb-4">Your order</h5>
                  <ul class="list-unstyled mb-0">
                    {% for item in items %}
                    <li class="d-flex align-items-center justify-content-between"><strong class="small fw-bold">{{ item.product.name}} x {{item.quantity}}</strong><span class="text-muted small">${{item.get_total|floatformat:2}}</span></li>
                    <li class="border-bottom my-2"></li>
                    {% endfor %}
                    <li class="d-flex align-items-center justify-content-between"><strong class="text-uppercase small fw-bold">Total</strong><span>${{order.get_cart_total|floatformat:2}}</span></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
     
      <!-- JavaScript files-->
      <script src="{% static 'store/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
      <script src="{% static 'store/vendor/glightbox/js/glightbox.min.js' %}"></script>
      <script src="{% static 'store/vendor/nouislider/nouislider.min.js' %}"></script>
      <script src="{% static 'store/vendor/swiper/swiper-bundle.min.js' %}"></script>
      <script src="{% static 'store/vendor/choices.js/public/assets/scripts/choices.min.js' %}"></script>
      <script src="{% static 'store/js/front.js' %}"></script>
      <script src="{% static 'store/js/cart.js' %}"></script>
     
      <script type="text/javascript">
        var shipping = '{{order.shipping}}'
        var total = '{{order.get_cart_total|floatformat:2}}'
    
        if (shipping == 'False'){
           document.getElementById('shipping-info').innerHTML = ''
        }

        if (user != 'AnonymousUser'){
          document.getElementById('user-info').innerHTML= ''
        }
        if (shipping == 'False' && user != 'AnonymousUser'){
          document.getElementById('form-wrapper').classList.add("hidden")
          document.getElementById('payment-info').classList.remove("hidden")

        } 

        var form = document.getElementById('form')
		    form.addEventListener('submit', function(e){
	    	e.preventDefault()
	    	console.log('Form Submitted...')
	    	document.getElementById('form-button').classList.add("hidden");
	    	document.getElementById('payment-info').classList.remove("hidden");
	    })

      document.getElementById('make-payment').addEventListener('click', function(e){
        submitFormData()
      })
      function submitFormData(){
        console.log('Payment button clicked')

        var userFormData = {
          'name': null,
          'email': null,
          'total': total,
        }

        var shippingInfo = {
          'address': null,
          'city': null,
          'state': null,
          'zipcode': null,
        }
        if (shipping != 'False'){
	    		shippingInfo.address = form.address.value
		    	shippingInfo.city = form.city.value
		    	shippingInfo.state = form.state.value
		    	shippingInfo.zipcode = form.zipcode.value
	    	}

	    	if (user == 'AnonymousUser'){
	    		userFormData.name = form.name.value
	    		userFormData.email = form.email.value
	    	}

	  
        var url = "/process_order/"
	    	fetch(url, {
	    		method:'POST',
	    		headers:{
	    			'Content-Type':'applicaiton/json',
	    			'X-CSRFToken':csrftoken,
	    		}, 
	    		body:JSON.stringify({'form':userFormData, 'shipping':shippingInfo}),
	    		
	    	})
	    	.then((response) => response.json())
	    	.then((data) => {
				console.log('Success:', data);
				alert('Transaction completed');  
        cart = {}
        document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"
				window.location.href = "{% url 'home' %}"

				})
      }

      </script>


      

    
      <!-- FontAwesome CSS - loading as last, so it doesn't block rendering-->
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    </div>
  </body>
  {% endblock body %}
</html>